{% extends 'blog/base.html' %}

{% block content %}
<div class="card shadow-sm">
  <div class="card-body">
    <h2>{{ post.title }}</h2>
    
    {% if request.user == post.author %}
       <a href="{% url 'edit_post' post.pk %}" class="btn btn-warning btn-sm mt-3 w-100 w-md-auto">âœï¸ Edit</a>
       <a href="{% url 'delete_post' post.pk %}" class="btn btn-danger btn-sm mt-3 w-100 w-md-auto">ğŸ—‘ï¸ Delete</a>
    {% endif %}
    


    <p class="text-muted">By {{ post.author.username }} | {{ post.created_at|date:"M d, Y" }}</p>
    <hr>
    <p>{{ post.content }}</p>
    <button id="like-btn" class="btn btn-outline-danger btn-sm mt-2">
       â¤ï¸ Like (<span id="like-count">{{ post.likes.count }}</span>)
    </button><input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

    <hr>
    <h5>ğŸ’¬ Comments</h5>

{% for comment in comments %}
  <div class="card mb-2 shadow-sm">
    <div class="card-body py-2">
      <p class="mb-1">{{ comment.text }}</p>
      <small class="text-muted">
        â€” {{ comment.author.username }} | {{ comment.created_at|date:"M d, Y H:i" }}
      </small>
    </div>
  </div>
{% empty %}
  <p class="text-muted">No comments yet.</p>
{% endfor %}

{% if user.is_authenticated %}
  <form method="post" class="mt-3">
    {% csrf_token %}
    {{ form.text }}
    <button type="submit" class="btn btn-primary btn-sm mt-2">Post Comment</button>
  </form>
{% else %}
  <p class="text-muted mt-3">Login to add a comment.</p>
{% endif %}


  </div>
</div>

<script>
  function getCSRFToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]').value;
  }

  const likeBtn = document.getElementById("like-btn");
  const likeCount = document.getElementById("like-count");

  likeBtn.addEventListener("click", () => {
    fetch("{% url 'toggle_like' post.pk %}", {
      method: "POST",
      headers: {
        "X-CSRFToken": getCSRFToken(),
        "X-Requested-With": "XMLHttpRequest"
      }
    })
    .then(response => response.json())
    .then(data => {
      likeCount.textContent = data.likes_count;
      likeBtn.classList.toggle("btn-danger", data.liked);
      likeBtn.classList.toggle("btn-outline-danger", !data.liked);
    });
  });
</script>

{% endblock %}